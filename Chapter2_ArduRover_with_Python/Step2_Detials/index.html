<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Step2 Detials - MAVROS Tutorial</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Step2 Detials";
    var mkdocs_page_input_path = "Chapter2_ArduRover_with_Python/Step2_Detials.md";
    var mkdocs_page_url = "/Chapter2_ArduRover_with_Python/Step2_Detials/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> MAVROS Tutorial</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../about/">About</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Chapter1 ArduRover with CLI</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Chapter1_ArduRover_with_CLI/Step1_How_to_change_mode/">Step1 How to change mode</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Chapter1_ArduRover_with_CLI/Step2_How_to_Arm_and_Disarm/">Step2 How to Arm and Disarm</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Chapter1_ArduRover_with_CLI/Step3_How_to_make_move/">Step3 How to make move</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Chapter1_ArduRover_with_CLI/Step4_How_to_set_and_get_parameters/">Step4 How to set and get parameters</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Chapter2 ArduRover with Python</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../Step1_Drive_rover/">Step1 Drive rover</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Step2 Detials</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#details-of-mavros_python_examples">Details of "mavros_python_examples"</a></li>
    

    <li class="toctree-l3"><a href="#introduction">Introduction</a></li>
    

    <li class="toctree-l3"><a href="#explaining-details">Explaining details</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#defining-a-class-for-topics-and-services">Defining a class for TOPICS and SERVICES</a></li>
        
            <li><a class="toctree-l4" href="#defining-a-class-for-handling-ros-topics-and-services">Defining a class for handling ROS topics and services</a></li>
        
            <li><a class="toctree-l4" href="#defining-a-class-for-using-rover-functionality">Defining a class for using Rover functionality</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../Step3_How_to_use/">Step3 How to use</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Chapter3 ArduRover with C++</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Chapter3_ArduRover_with_C++/Step1_Drive_rover/">Step1 Drive rover</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Chapter3_ArduRover_with_C++/Step2_Details/">Step2 Details</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Chapter3_ArduRover_with_C++/Step3_How_to_use/">Step3 How to use</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">MAVROS Tutorial</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Chapter2 ArduRover with Python &raquo;</li>
        
      
    
    <li>Step2 Detials</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="details-of-mavros_python_examples">Details of "mavros_python_examples"</h1>
<p><em>Author:</em> Masoud Iranmehr</p>
<p><em>Github Page:</em> <a href="https://github.com/masoudir/mavros_tutorial">github.com/masoudir/mavros_tutorial</a></p>
<h1 id="introduction">Introduction</h1>
<p>This package constitutes of four different python classes to make an easy way to work with Ardupilot vehicles. These 
classes are described here.</p>
<h1 id="explaining-details">Explaining details</h1>
<h2 id="defining-a-class-for-topics-and-services">Defining a class for TOPICS and SERVICES</h2>
<p>At first, we have created a class named "TopicService" as below to define TOPICS and SERVICES more easily: </p>
<pre><code>class TopicService:
def __init__(self, name: str, classType):
    self.__name = name
    self.__classType = classType
    self.__data = None

def set_data(self, data):
    self.__data = data

def get_data(self):
    return self.__data

def get_type(self):
    return self.__classType

def get_name(self):
    return self.__name
</code></pre>
<p>As you see, in this class three parameters has been defined: </p>
<ul>
<li>
<p>"name" is pointing to the name of TOPIC or SERVICE, </p>
</li>
<li>
<p>"classType" is pointing at the type of class used</p>
</li>
<li>
<p>"data" is pointing to the contents of this TOPIC or SERVICE</p>
</li>
</ul>
<h2 id="defining-a-class-for-handling-ros-topics-and-services">Defining a class for handling ROS topics and services</h2>
<p>Then we have defined the second class named "RosHandler" for handling TOPICS and SERVICES more easily in ROS environment.
The content of this class is as below:</p>
<pre><code>class RosHandler:
def __init__(self):
    self.rate = 1
    self.connected = False

def connect(self, node: str, rate: int):
    rospy.init_node(node, anonymous=True)
    self.rate = rospy.Rate(rate)
    self.connected = True
    rospy.loginfo("Rospy is up ...")
    rospy.spin()

def disconnect(self):
    if self.connected:
        rospy.loginfo("shutting down rospy ...")
        rospy.signal_shutdown("disconnect")
        self.connected = False

@staticmethod
def topic_publisher(topic: TopicService):
    pub = rospy.Publisher(topic.get_name(), topic.get_type(), queue_size=10)
    pub.publish(topic.get_data())
    print("edfgedge")

@staticmethod
def topic_subscriber(topic: TopicService):
    rospy.Subscriber(topic.get_name(), topic.get_type(), topic.set_data)

@staticmethod
def service_caller(service: TopicService, timeout=30):
    try:
        srv = service.get_name()
        typ = service.get_type()
        data = service.get_data()

        rospy.loginfo("waiting for ROS service:" + srv)
        rospy.wait_for_service(srv, timeout=timeout)
        rospy.loginfo("ROS service is up:" + srv)
        call_srv = rospy.ServiceProxy(srv, typ)
        return call_srv(data)
    except rospy.ROSException as e:
        print("ROS ERROR:", e)
    except rospy.ROSInternalException as e:
        print("ROS ERROR:", e)
    except KeyError as e:
        print("ERROR:", e)
    return None
</code></pre>
<p>Becareful to execute "topic_subscriber()" function before connecting to the vehicle in MAVROS. This function creates and 
event handler for receiving data from ros.</p>
<p>Then you can connect to your vehicle using "connect()" function. This takes two arguments "name" and "rate", which are 
the name of the node in ROS established by this code and the speed of receiving data from TOPICS in ROS respectively.</p>
<p>It is noted that the actual rate of receiving data from each topic is directly related to the rater defined in that topic.
This means that if a specific topic has been established on the rate of 40 Hz, you can update its data in the rate of 40 Hz
despite the rate you have been used on the function of "connect()".</p>
<p>You can publish your topics via "topic_publisher()" function and also you can send you service commands via "service_caller"
function.</p>
<h2 id="defining-a-class-for-using-rover-functionality">Defining a class for using Rover functionality</h2>
<p>For using Rover vehicle, we need to define its TOPICS and SERVICES and define the rules on how to use them. These are 
accomplished on this class as below:</p>
<pre><code>class RoverHandler(RosHandler):
def __init__(self):
    super().__init__()
    self.armed = False
    self.mode = ""

    self.TOPIC_STATE = TopicService("/mavros/state", mavros_msgs.msg.State)
    self.SERVICE_ARM = TopicService("/mavros/cmd/arming", mavros_msgs.srv.CommandBool)
    self.SERVICE_SET_MODE = TopicService("/mavros/set_mode", mavros_msgs.srv.SetMode)
    self.SERVICE_SET_PARAM = TopicService("/mavros/param/set", mavros_msgs.srv.ParamSet)
    self.SERVICE_GET_PARAM = TopicService("/mavros/param/get", mavros_msgs.srv.ParamGet)
    self.TOPIC_SET_POSE_GLOBAL = TopicService('/mavros/setpoint_raw/global', mavros_msgs.msg.GlobalPositionTarget)

    self.thread_param_updater = threading.Timer(0, self.update_parameters_from_topic)
    self.thread_param_updater.daemon = True
    self.thread_param_updater.start()

def enable_topics_for_read(self):
    self.topic_subscriber(self.TOPIC_STATE)

def arm(self, status: bool):
    data = mavros_msgs.srv.CommandBoolRequest()
    data.value = status
    self.SERVICE_ARM.set_data(data)
    result = self.service_caller(self.SERVICE_ARM, timeout=30)
    return result.success, result.result

def change_mode(self, mode: str):
    data = mavros_msgs.srv.SetModeRequest()
    data.custom_mode = mode
    self.SERVICE_SET_MODE.set_data(data)
    result = self.service_caller(self.SERVICE_SET_MODE, timeout=30)
    return result.mode_sent

def move(self, lat: float, lon: float, alt: float):
    data = mavros_msgs.msg.GlobalPositionTarget()
    data.latitude = lat
    data.longitude = lon
    data.altitude = alt
    self.TOPIC_SET_POSE_GLOBAL.set_data(data)
    self.topic_publisher(topic=self.TOPIC_SET_POSE_GLOBAL)

def get_param(self, param: str):
    data = mavros_msgs.srv.ParamGetRequest()
    data.param_id = param
    self.SERVICE_GET_PARAM.set_data(data)
    result = self.service_caller(self.SERVICE_GET_PARAM, timeout=30)
    return result.success, result.value.integer, result.value.real

def set_param(self, param: str, value_integer: int, value_real: float):
    data = mavros_msgs.srv.ParamSetRequest()
    data.param_id = param
    data.value.integer = value_integer
    data.value.real = value_real
    self.SERVICE_SET_PARAM.set_data(data)
    result = self.service_caller(self.SERVICE_SET_PARAM, timeout=30)
    return result.success, result.value.integer, result.value.real

def update_parameters_from_topic(self):
    while True:
        if self.connected:
            data = self.TOPIC_STATE.get_data()
            self.armed = data.armed
            self.mode = data.mode
</code></pre>
<p>As you see, there are some TOPICS and SERVICES defined using the class of "TopicService":</p>
<ul>
<li>
<p>Topic "/mavros/state" for reading the total status of the vehicle which its class type is "mavros_msgs.msg.State" in python</p>
</li>
<li>
<p>Topic "/mavros/setpoint_raw/global" for publishing the destination location of vehicle to move and its class type is "mavros_msgs.msg.GlobalPositionTarget" in python</p>
</li>
<li>
<p>Service "/mavros/cmd/arming" for arming the vehicle which its class type is "mavros_msgs.srv.CommandBool" in python</p>
</li>
<li>
<p>Service "/mavros/set_mode" for changing the vehicle mode which its class type is "mavros_msgs.srv.SetMode" in python</p>
</li>
<li>
<p>Service "/mavros/param/set" for setting the parameters of the vehicle which its class type is "mavros_msgs.srv.ParamSet" in python</p>
</li>
<li>
<p>Service "/mavros/param/get" for getting the parameters of the vehicle which its class type is "mavros_msgs.srv.ParamGet" in python</p>
</li>
</ul>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Step3_How_to_use/" class="btn btn-neutral float-right" title="Step3 How to use">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Step1_Drive_rover/" class="btn btn-neutral" title="Step1 Drive rover"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Step1_Drive_rover/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Step3_How_to_use/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>

</body>
</html>
